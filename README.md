

# Dynamic User Segmentation Service

Данный REST HTTP API сервис позволяет динамически создавать и удалять тестируемые сегменты, добавлять в них и удалять из них пользователей, получать список сегментов, в которых состоит пользователь. Также исполнен функционал получения списка действий, совершённых над пользователем, временного добавления пользователя в сегмент и случайного распределения определённого процента пользователей в новый сегмент.

## Используемые технологии
- <a href="https://github.com/gin-gonic/gin">gin-gonic/gin</a> в качестве веб-фреймворка
- Библиотека <a href="https://github.com/jmoiron/sqlx">jmoiron/sqlx</a> для работы с базой данных
- Библиотека <a href="https://github.com/spf13/viper">spf13/viper</a> для конфигурации приложения и работы с окружением
- Фреймворк <a href="https://github.com/swaggo/swag">swaggo/swag</a> для спецификации API 
- PostgreSQL в качестве базы данных
- Docker для запуска приложения
- Архитектура Clean Architecture и технология Graceful Shutdown

## Для запуска приложения:

```sh
  make build && make run
```

## Детали реализации
- В сервисе реализована валидация входных значений. 
  - Для сегментов:
    - Невозможно создать два сегмента с одним названием.
    - Невозможно удалить несуществующий сегмент.
  - Для пользователей:
    - Невозможно дважды добавить одного пользователя в один сегмент.
    - Невозможно добавить пользователя в несуществующий сегмент или сегмент, в котором уже состоит.
    - Невозможно удалить пользователя из несуществующего сегмента или сегмента, в котором он не состоит.
- В целях разработки и тестирования TTL добавления пользователя в сегмент считается в секундах, однако при надобности это значение в продакшене можно поменять и на количество часов/дней.
- При каждом запуске приложения создаётся чистая база данных со всеми нужными таблицами.
- При равных нулю значениях chance (процент пользователей, который надо добавить в создаваемый сегмент) и TTL эти параметры будут проигнорированны. 
- При удалении сегмента пользователи, состоявшие в нём, каскадно удаляются из него во всех необходимых таблицах.
- .env файл добавлен только для удобства, в продакшене (и в финальной версии репозитория) его быть, конечно же, не должно.
- Запрос на получение действий, совершённых над пользователем, возвращает JSON ответ со списком записей вида заданного .csv файла.

## Описание API
Подробно ознакомиться с API и протестировать функции можно на Swagger страничке, подключившись к `localhost:8000/swagger/index.html`

### Сегменты

#### Create a Segment
```http
  POST /segment/create/
```
| Параметр    | Тип       | Описание                    |
| :---------- | :-------- | :-------------------------  |
| `seg_name`  | `string`  | **Обязателен**. Название создаваемого сегмента |
| `chance`    | `int`     | Процент пользователей, случайно добавляемых в создаваемый сегмент |

```json
{
  "seg_name": "AVITO_VOICE_CHAT_MESSAGES",
  "chance": 10
}
```

#### Delete a Segment
```http
  POST /segment/delete/
```
| Параметр    | Тип       | Описание                    |
| :---------- | :-------- | :-------------------------- |
| `seg_name`  | `string`  |   **Обязателен**. Название удаляемого сегмента |

```json
{
  "seg_name": "AVITO_VOICE_CHAT_MESSAGES"
}
```

### Пользователи

#### Add User to Segment(s)
```http
  POST /user/addToSegment/
```
| Параметр    | Тип         | Описание                    |
| :--------   | :---------- | :-------------------------- |
| `id`        | `int`       | **Обязателен**. ID пользователя |
| `seg_names` | `[]string`  | **Обязателен**. Список сегментов, в которые добавляется пользователь |
| `TTL`       | `int`       | Времянной интервал, на который пользователь добавляется в сегмент(ы) |

```json
{
  "id": 1000,
  "seg_names": ["AVITO_VOICE_CHAT_MESSAGES"],
  "TTL": 0
}
```

#### Remove User from Segment(s)
```http
  POST /user/removeFromSegment/
```
| Параметр      | Тип         | Описание                          |
| :------------ | :---------- | :-------------------------------- |
| `id`          | `int`       | **Обязателен**. ID пользователя   |
| `seg_names`   | `[]string`  | **Обязателен**. Список сегментов, из которых удаляется пользователь |

```json
{
  "id": 1000,
  "seg_names": ["AVITO_VOICE_CHAT_MESSAGES"]
}
```

#### Get User's Segments by ID
```http
  GET /user/getSegments/{id}
```
| Параметр  | Тип       | Описание                        |
| :-------- | :-------  | :------------------------------ |
| `id`      | `int`     | **Обязателен**. ID пользователя |

```http
  GET /user/getSegments/1000
```

#### Get User Actions
```http
  POST /user/getActions/
```
| Параметр  | Тип       | Описание                                                |
| :-------- | :-------  | :------------------------------------------------------ |
| `id`      | `int`     | **Обязателен**. ID пользователя                         |
| `month`   | `int`     | **Обязателен**. Месяц, записи после которого требуются  |
| `year`    | `int`     | **Обязателен**. Год, записи после которого требуются    |

```json
{
  "id": 1000,
  "month": 8,
  "year": 2023
}
```

